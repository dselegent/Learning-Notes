# 03 【Nginx虚拟主机和域名解析】

虚拟主机使用特殊的软硬件技术，把一台运行在因特网上的服务器主机分成一台台“虚拟”的主机，每一台虚拟主机都具有独立的域名，具有完整的Internet服务器（WWW、FTP、Email等）功能，虚拟主机之间完全独立，并可由用户自行管理，在外界看来，每一台虚拟主机和一台独立的主机完全一样。

域名解析就是域名到IP地址的转换过程，IP地址是网路上标识站点的数字地址，为了简单好记，采用域名来代替ip地址标识站点地址，域名的解析工作由DNS服务器完成。

## 1.域名、dns、ip地址的关系

- 域名是相对网站来说的，IP是相对网络来说的。当输入一个域名的时候，网页是如何做出反应的？

输入域名---->域名解析服务器（dns）解析成ip地址—>访问IP地址—>完成访问的内容—>返回信息。

- Internet上的计算机IP是唯一的，一个IP地址对应一个计算机。

一台计算机上面可以有很多个服务，也就是一个ip地址对应了很多个域名，即一个计算机上有很多网站。

**IP地址和DNS地址的区别**

IP地址是指单个主机的唯一IP地址，而DNS服务器地址是用于域名解析的地址。

一个是私网地址，一个是公网地址；

一个作为主机的逻辑标志，一个作为域名解析服务器的访问地址。

**IP地址**

IP，就是Internet Protocol的缩写，是一种通信协议，我们用的因特网基本是IP网组成的。

IP地址就是因特网上的某个设备的一个编号。

IP地址一般由网络号，主机号，掩码来组成。

IP网络上有很多路由器，路由器之间转发、通信都是只认这个IP地址，类似什么哪？就好像你寄包裹，你的写上发件人地址，你的姓名，收件人地址，收件人姓名。

这个发件人地址就是你电脑的IP的网络号，你的姓名就是你的主机号。

收件人的地址就是你要访问的IP的网络号，收件人的姓名就是访问IP的主机号。

现在还有了更复杂的IPV6,还有IPV9。

**DNS是什么？**

我们访问因特网必须知道对端的IP地址，可是我们访问网站一般只知道域名啊，怎么办？

这时候DNS就有用处了，电脑先访问DNS服务器，查找域名对应的IP,于是，你的电脑就知道要发包到IP地址了。

## 2.http协议

HTTP是一个应用层协议，由请求和响应构成，是一个标准的客户端服务器模型。HTTP是一个无状态的协议。

HTTP协议通常承载于TCP协议之上，有时也承载于TLS或SSL协议层之上，这个时候，就成了我们常说的HTTPS。如下图所示：

![image-20220823112632146](https://i0.hdslb.com/bfs/album/cad7e4d03f01d64a1f8c0e5e841030b0c9fbd26b.png)

客户端与服务器的数据交互的流程：

1）首先客户机与服务器需要建立TCP连接。只要单击某个超级链接，HTTP的工作开始，下图是TCP连接流程。

![image-20220823112651941](https://i0.hdslb.com/bfs/album/6d258d5fe8ebfeebbc20ef86409e20cf10704801.png)

2）建立连接后，客户机发送一个请求给服务器，请求方式的格式为：统一资源标识符（URL）、协议版本号，后边是MIME信息包括请求修饰符、客户机信息和可能的内容。

3）服务器接到请求后，给予相应的响应信息，其格式为一个状态行，包括信息的协议版本号、一个成功或错误的代码，后边是MIME信息包括服务器信息、实体信息和可能的内容，例如返回一个HTML的文本。

4）客户端接收服务器所返回的信息通过浏览器显示在用户的显示屏上，然后客户机与服务器断开连接。如果在以上过程中的某一步出现错误，那么产生错误的信息将返回到客户端，有显示屏输出。对于用户来说，这些过程是由HTTP自己完成的，用户只要用鼠标点击，等待信息显示就可以了。

## 3.虚拟主机原理

虚拟主机是为了在同一台物理机器上运行多个不同的网站，提高资源利用率引入的技术。

一般的web服务器一个ip地址的80端口只能正确对应一个网站。web服务器在不使用多个ip地址和端口的情况下，如果需要支持多个相对独立的网站就需要一种机制来分辨同一个ip地址上的不同网站的请求，这就出现了主机头绑定的方法。简单的说就是，将不同的网站空间对应不同的域名，以连接请求中的域名字段来分发和应答正确的对应空间的文件执行结果。举个例子来说，一台服务器ip地址为192.168.8.101，有两个域名和对应的空间在这台服务器上，使用的都是192.168.8.101的80端口来提供服务。如果只是简单的将两个域名A和B的域名记录解析到这个ip地址，那么web服务器在收到任何请求时反馈的都会是同一个网站的信息，这显然达不到要求。接下来我们使用主机头绑定域名A和B到他们对应的空间文件夹C和D。当含有域名A的web请求信息到达192.168.8.101时，web服务器将执行它对应的空间C中的首页文件，并返回给客户端，含有域名B的web请求信息同理，web服务器将执行它对应的空间D中的首页文件，并返回给客户端，所以在使用主机头绑定功能后就不能使用ip地址访问其上的任何网站了，因为请求信息中不存在域名信息，所以会出错。

## 4.使用host文件解析域名

![image-20230805180808945](https://article.biliimg.com/bfs/article/d807d76ce297eef29232d689448439a7dfb14549.png)

修改完成后，访问虚拟机的ip解析的域名 

![image-20230805180856460](https://article.biliimg.com/bfs/article/de1e07f398a67b9c186ed66941a5412cb1e12a39.png)

> 还可以通过域名解析 然后连接到内网
>
> 我们在阿里云的dns域名解析上面添加添加了我们域名和内网ip的对应关系，仅仅只是对应关系，所以我们ping域名可以解析成我们的内网ip，由于终端与对应机器在同一局域网所以能通，你换个不在同一内网的不行

## 5.虚拟主机域名配置

在根目录的`www`目录下创建文件夹`test`，里面在创建两个文件夹`test1`和`test2`，分别创建`index.html`：

![image-20230805181232579](https://article.biliimg.com/bfs/article/6587c46a2d0d1b81aed5a18aa32c8fad3a52f078.png)

使用腾讯云`DNSPod`添加域名解析记录：

![image-20230805181614222](https://article.biliimg.com/bfs/article/fb1fd8e2b1fc20f3fe655f3e5f4ab82559ccdcfc.png)

修改`nginx.conf`：

```bash
      server {
        listen 80;
        server_name test1.dselegent.icu;
        location /
        {
           root /www/test/test1;
           index index.html index.htm;
        }
      }
      
        server {
        listen 80;
        server_name test2.dselegent.icu;
        location /
        {
           root /www/test/test2;
           index index.html index.htm;
        }
      }
```

重新加载服务：`systemctl reload nginx`。

结果：

![image-20230805181750749](https://article.biliimg.com/bfs/article/2b02b3d9474c1bcba9e7b132d3981e99fa3d1f30.png)

![image-20230805181805077](https://article.biliimg.com/bfs/article/d8b91ea0fe41fa6595bc79d15945dca314f2d33a.png)

**注意：**

虚拟主机技术server中，相同的主机端口号会报错。

可以这样配置：

- listen 80;		server_name  www.website.com;
- listen 88;		server_name qqq.website.com;

两者组合起来不重复就可以了。

## 6.泛域名

所谓“泛域名解析”是指：利用通配符* （星号）来做次级域名以实现所有的次级域名均指向同一IP地址。

好处：

1.可以让域名支持无限的子域名(这也是泛域名解析最大的用途)。

2.防止用户错误输入导致的网站不能访问的问题

3.可以让直接输入网址登陆网站的用户输入简洁的网址即可访问网站

泛域名在实际使用中作用是非常广泛的，比如实现无限二级域名功能，提供免费的url转发，在IDC部门实现自动分配免费网址，在大型企业中实现网址分类管理等等，都发挥了巨大的作用。

在腾讯云的域名配置如下：

![image-20230805183845203](https://article.biliimg.com/bfs/article/e73477bdb9f99b1928ef771a32bd08a6bec2602b.png)

## 7.域名解析规则

我们可以在同一个`server_name`中配置多个域名

> 此处所有配置都是指的nginx配置。

**完整匹配**
server中可以配置多个域名，例如：

`server_name  test1.dselegent.icu  test2.dselegent.icu;`

**通配符匹配**
使用通配符的方式如下：

`server_name  *.dselegent.icu;`

需要注意的是完整匹配的优先级大于通配符匹配和正则匹配。

**通配符结束匹配**
使用通配符结束匹配的方式如下：

`server_name  www.dselegent.*;`

**正则匹配**

采用正则的匹配方式如下:

`server_name  ~^[0-9]+\.dselegent\.icu$`

访问:`123456.dselegent.icu`

正则匹配格式，必须以`~`开头，比如：`server_name ~^www\d+\.example\.net$;`。如果开头没有~，则nginx认为是精确匹配。在逻辑上，需要添加^和$锚定符号。注意，正则匹配格式中.为正则元字符，如果需要匹配.，则需要反斜线转义。如果正则匹配中含有{和}则需要双引号引用起来，避免nginx报错，如果没有加双引号，则nginx会报如下错误：`directive "server_name" is not terminated by ";" in ...`。

**匹配顺序**

```css
1. 精确的名字
2. 以*号开头的最长通配符名称，例如 *.example.org
3. 以*号结尾的最长通配符名称，例如 mail.*
4. 第一个匹配的正则表达式（在配置文件中出现的顺序）
```