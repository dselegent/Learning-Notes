# 02 ã€ä½¿ç”¨é¢„åŠ è½½è„šæœ¬ã€‘

## 1.ä»€ä¹ˆæ˜¯é¢„åŠ è½½è„šæœ¬ï¼Ÿ

Electron çš„ä¸»è¿›ç¨‹æ˜¯ä¸€ä¸ªæ‹¥æœ‰ç€å®Œå…¨æ“ä½œç³»ç»Ÿè®¿é—®æƒé™çš„ Node.js ç¯å¢ƒã€‚ é™¤äº† [Electron æ¨¡ç»„](https://www.electronjs.org/zh/docs/latest/api/app) ä¹‹å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ [Node.js å†…ç½®æ¨¡å—](https://nodejs.org/dist/latest/docs/api/) å’Œæ‰€æœ‰é€šè¿‡ npm å®‰è£…çš„è½¯ä»¶åŒ…ã€‚ å¦ä¸€æ–¹é¢ï¼Œå‡ºäºå®‰å…¨åŸå› ï¼Œæ¸²æŸ“è¿›ç¨‹é»˜è®¤è·‘åœ¨ç½‘é¡µé¡µé¢ä¸Šï¼Œè€Œå¹¶é Node.jsé‡Œã€‚

ä¸ºäº†å°† Electron çš„ä¸åŒç±»å‹çš„è¿›ç¨‹æ¡¥æ¥åœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨è¢«ç§°ä¸º **é¢„åŠ è½½** çš„ç‰¹æ®Šè„šæœ¬ã€‚

## 2.ä½¿ç”¨é¢„åŠ è½½è„šæœ¬æ¥å¢å¼ºæ¸²æŸ“å™¨

BrowserWindow çš„é¢„åŠ è½½è„šæœ¬è¿è¡Œåœ¨å…·æœ‰ HTML DOM å’Œ Node.jsã€Electron API çš„æœ‰é™å­é›†è®¿é—®æƒé™çš„ç¯å¢ƒä¸­ã€‚

> **é¢„åŠ è½½è„šæœ¬æ²™ç›’åŒ–**
>
> ä» Electron 20 å¼€å§‹ï¼Œé¢„åŠ è½½è„šæœ¬é»˜è®¤ **æ²™ç›’åŒ–** ï¼Œä¸å†æ‹¥æœ‰å®Œæ•´ Node.js ç¯å¢ƒçš„è®¿é—®æƒã€‚ å®é™…ä¸Šï¼Œè¿™æ„å‘³ç€ä½ åªæ‹¥æœ‰ä¸€ä¸ª polyfilled çš„ `require` å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åªèƒ½è®¿é—®ä¸€ç»„æœ‰é™çš„ APIã€‚
>
> | å¯ç”¨çš„ API            | è¯¦ç»†ä¿¡æ¯                                                     |
> | --------------------- | ------------------------------------------------------------ |
> | Electron æ¨¡å—         | æ¸²æŸ“è¿›ç¨‹æ¨¡å—                                                 |
> | Node.js æ¨¡å—          | [`events`](https://nodejs.org/api/events.html)ã€[`timers`](https://nodejs.org/api/timers.html)ã€[`url`](https://nodejs.org/api/url.html) |
> | Polyfilled çš„å…¨å±€æ¨¡å— | [`Buffer`](https://nodejs.org/api/buffer.html)ã€[`process`](https://www.electronjs.org/zh/docs/latest/api/process)ã€[`clearImmediate`](https://nodejs.org/api/timers.html#timers_clearimmediate_immediate)ã€[`setImmediate`](https://nodejs.org/api/timers.html#timers_setimmediate_callback_args) |
>
> æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·é˜…è¯» [æ²™ç›’è¿›ç¨‹](https://www.electronjs.org/zh/docs/latest/tutorial/sandbox) æ•™ç¨‹ã€‚

é¢„åŠ è½½è„šæœ¬åƒ Chrome æ‰©å±•çš„ [å†…å®¹è„šæœ¬](https://developer.chrome.com/docs/extensions/mv3/content_scripts/)ï¼ˆContent Scriptï¼‰ä¸€æ ·ï¼Œä¼šåœ¨æ¸²æŸ“å™¨çš„ç½‘é¡µåŠ è½½ä¹‹å‰æ³¨å…¥ã€‚ å¦‚æœä½ æƒ³å‘æ¸²æŸ“å™¨åŠ å…¥éœ€è¦ç‰¹æ®Šæƒé™çš„åŠŸèƒ½ï¼Œä½ å¯ä»¥é€šè¿‡ [contextBridge](https://www.electronjs.org/zh/docs/latest/api/context-bridge) æ¥å£å®šä¹‰ [å…¨å±€å¯¹è±¡](https://developer.mozilla.org/en-US/docs/Glossary/Global_object)ã€‚

ä¸ºäº†æ¼”ç¤ºè¿™ä¸€æ¦‚å¿µï¼Œä½ å°†ä¼šåˆ›å»ºä¸€ä¸ªå°†åº”ç”¨ä¸­çš„ Chromeã€Nodeã€Electron ç‰ˆæœ¬å·æš´éœ²è‡³æ¸²æŸ“å™¨çš„é¢„åŠ è½½è„šæœ¬

æ–°å»ºä¸€ä¸ª `preload.js` æ–‡ä»¶ã€‚è¯¥è„šæœ¬é€šè¿‡ `versions` è¿™ä¸€å…¨å±€å˜é‡ï¼Œå°† Electron çš„ `process.versions` å¯¹è±¡æš´éœ²ç»™æ¸²æŸ“å™¨ã€‚

```js
const { contextBridge } = require('electron')

contextBridge.exposeInMainWorld('versions', {
  node: () => process.versions.node,
  chrome: () => process.versions.chrome,
  electron: () => process.versions.electron,
  // èƒ½æš´éœ²çš„ä¸ä»…ä»…æ˜¯å‡½æ•°ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æš´éœ²å˜é‡
})
```

ä¸ºäº†å°†è„šæœ¬é™„åœ¨æ¸²æŸ“è¿›ç¨‹ä¸Šï¼Œåœ¨ BrowserWindow æ„é€ å™¨ä¸­ä½¿ç”¨ `webPreferences.preload` ä¼ å…¥è„šæœ¬çš„è·¯å¾„ã€‚

```js
const { app, BrowserWindow } = require('electron')
const path = require('path')

const createWindow = () => {
  const win = new BrowserWindow({
    width: 800,
    height: 600,
    webPreferences: {
      preload: path.join(__dirname, 'preload.js'),
    },
  })

  win.loadFile('index.html')
}

app.whenReady().then(() => {
  createWindow()
})
```

> **æç¤º**
>
> è¿™é‡Œä½¿ç”¨äº†ä¸¤ä¸ªNode.jsæ¦‚å¿µï¼š
>
> - [`__dirname`](https://nodejs.org/api/modules.html#modules_dirname) å­—ç¬¦ä¸²æŒ‡å‘å½“å‰æ­£åœ¨æ‰§è¡Œè„šæœ¬çš„è·¯å¾„ (åœ¨æœ¬ä¾‹ä¸­ï¼Œå®ƒæŒ‡å‘ä½ çš„é¡¹ç›®çš„æ ¹æ–‡ä»¶å¤¹)ã€‚
> - [`path.join`](https://nodejs.org/api/path.html#path_path_join_paths) API å°†å¤šä¸ªè·¯å¾„è”ç»“åœ¨ä¸€èµ·ï¼Œåˆ›å»ºä¸€ä¸ªè·¨å¹³å°çš„è·¯å¾„å­—ç¬¦ä¸²ã€‚

ç°åœ¨æ¸²æŸ“å™¨èƒ½å¤Ÿå…¨å±€è®¿é—® `versions` äº†ï¼Œè®©æˆ‘ä»¬å¿«å¿«å°†é‡Œè¾¹çš„ä¿¡æ¯æ˜¾ç¤ºåœ¨çª—å£ä¸­ã€‚ è¿™ä¸ªå˜é‡ä¸ä»…å¯ä»¥é€šè¿‡ `window.versions` è®¿é—®ï¼Œä¹Ÿå¯ä»¥å¾ˆç®€å•åœ°ä½¿ç”¨ `versions` æ¥è®¿é—®ã€‚ æ–°å»ºä¸€ä¸ª `renderer.js` è„šæœ¬ï¼Œ è¿™ä¸ªè„šæœ¬ä½¿ç”¨ [`document.getElementById`](https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementById) DOM æ¥å£æ¥æ›¿æ¢ `id` å±æ€§ä¸º `info` çš„ HTML å…ƒç´ æ˜¾ç¤ºæ–‡æœ¬ã€‚

`render.js`

```js
const information = document.getElementById('info')
information.innerText = `æœ¬åº”ç”¨æ­£åœ¨ä½¿ç”¨ Chrome (v${versions.chrome()}), Node.js (v${versions.node()}), å’Œ Electron (v${versions.electron()})`
```

ç„¶åè¯·ä¿®æ”¹ä½ çš„ `index.html` æ–‡ä»¶ã€‚åŠ ä¸Šä¸€ä¸ª `id` å±æ€§ä¸º `info` çš„å…¨æ–°å…ƒç´ ï¼Œå¹¶ä¸”è®°å¾—åŠ ä¸Šä½ çš„ `renderer.js` è„šæœ¬ï¼š

`index.html`

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self'"
    />
    <meta
      http-equiv="X-Content-Security-Policy"
      content="default-src 'self'; script-src 'self'"
    />
    <title>æ¥è‡ª Electron æ¸²æŸ“å™¨çš„é—®å¥½ï¼</title>
  </head>
  <body>
    <h1>æ¥è‡ª Electron æ¸²æŸ“å™¨çš„é—®å¥½ï¼</h1>
    <p>ğŸ‘‹</p>
    <p id="info"></p>
    <script src="./render.js"></script>
  </body>
</html>
```

åšå®Œè¿™å‡ æ­¥ä¹‹åï¼Œä½ çš„åº”ç”¨åº”è¯¥é•¿è¿™æ ·ï¼š

## 3.åœ¨è¿›ç¨‹ä¹‹é—´é€šä¿¡

æˆ‘ä»¬ä¹‹å‰æåˆ°ï¼ŒElectron çš„ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹æœ‰ç€æ¸…æ¥šçš„åˆ†å·¥å¹¶ä¸”ä¸å¯äº’æ¢ã€‚ è¿™ä»£è¡¨ç€æ— è®ºæ˜¯ä»æ¸²æŸ“è¿›ç¨‹ç›´æ¥è®¿é—® Node.js æ¥å£ï¼Œäº¦æˆ–è€…æ˜¯ä»ä¸»è¿›ç¨‹è®¿é—® HTML æ–‡æ¡£å¯¹è±¡æ¨¡å‹ (DOM)ï¼Œéƒ½æ˜¯ä¸å¯èƒ½çš„ã€‚

è§£å†³è¿™ä¸€é—®é¢˜çš„æ–¹æ³•æ˜¯ä½¿ç”¨è¿›ç¨‹é—´é€šä¿¡ (IPC)ã€‚å¯ä»¥ä½¿ç”¨ Electron çš„ `ipcMain` æ¨¡å—å’Œ `ipcRenderer` æ¨¡å—æ¥è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ã€‚ ä¸ºäº†ä»ä½ çš„ç½‘é¡µå‘ä¸»è¿›ç¨‹å‘é€æ¶ˆæ¯ï¼Œä½ å¯ä»¥ä½¿ç”¨ `ipcMain.handle` è®¾ç½®ä¸€ä¸ªä¸»è¿›ç¨‹å¤„ç†ç¨‹åºï¼ˆhandlerï¼‰ï¼Œç„¶ååœ¨é¢„å¤„ç†è„šæœ¬ä¸­æš´éœ²ä¸€ä¸ªè¢«ç§°ä¸º `ipcRenderer.invoke` çš„å‡½æ•°æ¥è§¦å‘è¯¥å¤„ç†ç¨‹åºï¼ˆhandlerï¼‰ã€‚

æˆ‘ä»¬å°†å‘æ¸²æŸ“å™¨æ·»åŠ ä¸€ä¸ªå«åš `ping()` çš„å…¨å±€å‡½æ•°æ¥æ¼”ç¤ºè¿™ä¸€ç‚¹ã€‚è¿™ä¸ªå‡½æ•°å°†è¿”å›ä¸€ä¸ªä»ä¸»è¿›ç¨‹ç¿»å±±è¶Šå²­è€Œæ¥çš„å­—ç¬¦ä¸²ã€‚

é¦–å…ˆï¼Œåœ¨é¢„å¤„ç†è„šæœ¬ä¸­è®¾ç½® `invoke` è°ƒç”¨ï¼š

`preload.js`

```js
const { contextBridge, ipcRenderer } = require('electron')

contextBridge.exposeInMainWorld('versions', {
  node: () => process.versions.node,
  chrome: () => process.versions.chrome,
  electron: () => process.versions.electron,
  ping: () => ipcRenderer.invoke('ping'),
  // èƒ½æš´éœ²çš„ä¸ä»…ä»…æ˜¯å‡½æ•°ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æš´éœ²å˜é‡
})
```

> **IPC å®‰å…¨**
>
> å¯ä»¥æ³¨æ„åˆ°æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªè¾…åŠ©å‡½æ•°æ¥åŒ…è£¹ `ipcRenderer.invoke('ping')` è°ƒç”¨ï¼Œè€Œå¹¶éç›´æ¥é€šè¿‡ context bridge æš´éœ² `ipcRenderer` æ¨¡å—ã€‚ ä½ **æ°¸è¿œ**éƒ½ä¸è¦æƒ³é€šè¿‡é¢„åŠ è½½ç›´æ¥æš´éœ²æ•´ä¸ª `ipcRenderer` æ¨¡å—ï¼Œè¿™å°†ä½¿å¾—ä½ çš„æ¸²æŸ“å™¨èƒ½å¤Ÿç›´æ¥å‘ä¸»è¿›ç¨‹å‘é€ä»»æ„çš„ IPC ä¿¡æ¯ï¼Œä¼šä½¿å¾—å…¶æˆä¸ºæ¶æ„ä»£ç æœ€å¼ºæœ‰åŠ›çš„æ”»å‡»åª’ä»‹ã€‚

ç„¶åï¼Œåœ¨ä¸»è¿›ç¨‹ä¸­è®¾ç½®ä½ çš„ `handle` ç›‘å¬å™¨ã€‚ æˆ‘ä»¬åœ¨ HTML æ–‡ä»¶åŠ è½½*ä¹‹å‰*å®Œæˆäº†è¿™äº›ï¼Œæ‰€ä»¥æ‰èƒ½ä¿è¯åœ¨ä½ ä»æ¸²æŸ“å™¨å‘é€ `invoke` è°ƒç”¨ä¹‹å‰å¤„ç†ç¨‹åºèƒ½å¤Ÿå‡†å¤‡å°±ç»ªã€‚

`main.js`

```js
const { app, BrowserWindow, ipcMain } = require('electron')
const path = require('path')

const createWindow = () => {
  const win = new BrowserWindow({
    width: 800,
    height: 600,
    webPreferences: {
      preload: path.join(__dirname, 'preload.js'),
    },
  })
  ipcMain.handle('ping', () => 'pong')
  win.loadFile('index.html')
}
app.whenReady().then(createWindow)
```

å°†å‘é€å™¨ä¸æ¥æ”¶å™¨è®¾ç½®å®Œæˆä¹‹åï¼Œç°åœ¨ä½ å¯ä»¥å°†ä¿¡æ¯é€šè¿‡åˆšåˆšå®šä¹‰çš„ `'ping'` é€šé“ä»æ¸²æŸ“å™¨å‘é€è‡³ä¸»è¿›ç¨‹å½“ä¸­ã€‚

`renderer.js`

```js
const func = async () => {
  const response = await window.versions.ping()
  console.log(response) // æ‰“å° 'pong'
}

func()
```

å¦‚æ¬²äº†è§£ä½¿ç”¨ `ipcRenderer` æ¨¡å—å’Œ `ipcMain` æ¨¡å—çš„è¯¦ç»†è¯´æ˜ï¼Œè¯·è®¿é—®å®Œæ•´çš„ [è¿›ç¨‹é—´é€šä¿¡](https://www.electronjs.org/zh/docs/latest/tutorial/ipc) æŒ‡å—ã€‚

## 4.æ‘˜è¦

é¢„åŠ è½½è„šæœ¬åŒ…å«åœ¨æµè§ˆå™¨çª—å£åŠ è½½ç½‘é¡µä¹‹å‰è¿è¡Œçš„ä»£ç ã€‚ å…¶å¯è®¿é—® DOM æ¥å£å’Œ Node.js ç¯å¢ƒï¼Œå¹¶ä¸”ç»å¸¸åœ¨å…¶ä¸­ä½¿ç”¨ `contextBridge` æ¥å£å°†ç‰¹æƒæ¥å£æš´éœ²ç»™æ¸²æŸ“å™¨ã€‚

ç”±äºä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹æœ‰ç€å®Œå…¨ä¸åŒçš„åˆ†å·¥ï¼ŒElectron åº”ç”¨é€šå¸¸ä½¿ç”¨é¢„åŠ è½½è„šæœ¬æ¥è®¾ç½®è¿›ç¨‹é—´é€šä¿¡ (IPC) æ¥å£ä»¥åœ¨ä¸¤ç§è¿›ç¨‹ä¹‹é—´ä¼ è¾“ä»»æ„ä¿¡æ¯ã€‚